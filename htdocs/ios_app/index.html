<!doctype html>
<html>
	<head>
      	<script type="text/javascript" src="jquery.js"></script>
      	<script type="text/javascript" src="aes.js"></script>
      	<script type="text/javascript" src="openpgp.js"></script>

		<link href='https://fonts.googleapis.com/css?family=Advent+Pro:400,500,600,700,300,200,100' rel='stylesheet' type='text/css'>
		<meta name="apple-mobile-web-app-capable" content="yes" />
      	<meta name="apple-mobile-web-app-status-bar-style" content="default" />
      	<meta name="viewport" content="user-scalable=no, width=device-width" />
		<style>
			body {
				font-family: "Advent Pro";
			}
			* {
				box-sizing: border-box;
				-webkit-tap-highlight-color: rgba(0,0,0,0);
  				-webkit-tap-highlight-color: transparent; 
			}
			body, html {
				padding: 0;
				margin: 0;
			}
			h1 {
				padding: 0;
				margin: 0;
			}
			section {
				width: 100%;
				padding: 10px;
				position: absolute;
			}
			.appTitle {
				font-weight: 100;
				text-align: center;
				font-size:32pt;
				width: 100%;
			}
			.hiding {
				display: none;
			}
			section > p {
				font-weight: 600;
				text-align: center;
			}
			.pin-form input[type="text"], 
			.pin-form input[type="password"],
			.pin-form input[type="button"]
			{
				border: 1px solid;
				width: 15%;
				margin-left: 5%;
				height: 50px;
				font-size: 36pt;
				border-radius: 0;
				text-align: center;
			}
			.pin-form input[disabled] {
				background: #ffffff;
				color: #000000;
				border: 1px solid;
				margin-left: 6%;
				font-size:16pt;
			}
			.pin-form input[type="button"] {
				width: 33%;
				height: 100px;
				border-radius: 50px;
				background: #000000;
				color: #ffffff;
				margin:0;
				padding: 0;
				-webkit-appearance:none;
				float:left;
			}
			.pin-form input[type="button"]:active {
				color: #000000;
				background: #ffffff;
			}
			.big-btn {
				border: 0;
				width: 100%;
				padding: 15px;
				border-radius: 15px;
				border: 1px solid #000000;
				background: #ffffff;
				color: #000000;
				text-align: center;
				height: 70px;
				line-height: 45px;
				font-weight: 700;
				-webkit-appearance: none;
				margin-top:10px;
				clear:both;
				text-decoration: none;
				font-family: "Advent Pro";
				font-size: 13pt;
			}
			.big-btn:active {
				background: #000000;
				color: #ffffff;
			}
			.big-btn[disabled] {
				opacity:0.4;
			}
			.normal-font p {
				font-family: Arial, sans-serif;
				text-align:left;
			}
			.normal-center {
				text-align:center;
				font-family: Arial;
				font-size: 16pt;
			}
		</style>
		<title>Ciphertext</title>
	</head>
	<body ontouchstart="">

		<section id="app_page" class="hiding">
			<h1 class="appTitle">Ciphertext</h1>
			<p class="id-name hiding normal-center"></p>
			<input type="button" class="big-btn app-id-action" value="Create Identity">
            <input type="button" class="big-btn app-identity-data hiding" value="Identity Data">
			<input type="button" class="big-btn app-clear-pin" value="Clear All Data">
			<input type="button" class="big-btn app-help" value="Help">
			<input type="button" class="big-btn app-messages hiding" value="Messages">
		</section>

		<section id="app_messages" class="hiding">
			<p>Messages</p>
			<input type="button" class="big-btn app-close-messages" value="Back">
		</section>
        
        <section id="app_id_data" class="hiding">
            <p>Your ID is <span class="id-display"></span></p>
            <p>Created: <span class="id-created-date"></span></p>
            <input type="button" class="big-btn app-close-id-data" value="Back">
        </section>

		<section id="app_help" class="hiding normal-font">
			<h1 class="appTitle">Ciphertext Help</h1>
			<p>Ciphertext is a secure, anonymous chat and message service used for the sensitive andclassified transfer of information.</p>

			<p>You can create and destroy your chat conversations, and your <strong>identities</strong> at any time. An identity is simply a "user". You'll be given a random set of numbmers and letters - that serves as your username for that identity and is how people will contact you. Each identity comes with a 2048-bit PGP keypair generated <strong>on the device, and NEVER transferred outside the device itself.</strong></p>
			<p>When you add someone (or vice-versa) to your contacts, the server only acts as a transport of user public keys, never private keys. When someone sends you a message, they use their private key, and your puiblic key to encrypt the message that nobody else besides you two will ever be able to decrypt it. </p>
			<p>What makes <strong>Ciphertext</strong> secure and unique, is that the transfer of private keys, and passwords never happens. It's all client-based. We never know your PINs, or your keypair passwords.</p>
		
			<input type="button" class="big-btn app-close-help" value="Back">
		</section>

		<section id="app_setup" class="hiding">
			<p>Choose a Master PIN.</p>

			<form action="" method="post" class="pin-form" id="new_masterpass_form">
				<input type="password" class="pin-display" maxlength="1" data-idx="0" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="1" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="2" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="3" disabled>

				<p></p>

				<input type="button" value="1">
				<input type="button" value="2">
				<input type="button" value="3"><br>
				<input type="button" value="4">
				<input type="button" value="5">
				<input type="button" value="6"><br>
				<input type="button" value="7">
				<input type="button" value="8">
				<input type="button" value="9"><br>
				<input type="button" value="0">
				<input type="button" value="<<" class="pin-back">
			</form>
		</section>

		<section id="app_setup2" class="hiding">
			<p>Confirm your Master PIN.</p>

			<form action="" method="post" class="pin-form" id="new_masterpass_form2">
				<input type="password" class="pin-display" maxlength="1" data-idx="0" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="1" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="2" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="3" disabled>

				<p></p>

				<input type="button" value="1">
				<input type="button" value="2">
				<input type="button" value="3"><br>
				<input type="button" value="4">
				<input type="button" value="5">
				<input type="button" value="6"><br>
				<input type="button" value="7">
				<input type="button" value="8">
				<input type="button" value="9"><br>
				<input type="button" value="0">
				<input type="button" value="<<" class="pin-back">
			</form>
		</section>

		<section id="app_login" class="hiding">
			<p>Enter Your Master PIN.</p>

			<form action="" method="post" class="pin-form" id="login_masterpass_form">
				<input type="password" class="pin-display" maxlength="1" data-idx="0" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="1" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="2" disabled>
				<input type="password" class="pin-display" maxlength="1" data-idx="3" disabled>

				<p></p>

				<input type="button" value="1">
				<input type="button" value="2">
				<input type="button" value="3"><br>
				<input type="button" value="4">
				<input type="button" value="5">
				<input type="button" value="6"><br>
				<input type="button" value="7">
				<input type="button" value="8">
				<input type="button" value="9"><br>
				<input type="button" value="0">
				<input type="button" value="<<" class="pin-back">
			</form>
		</section>

		<script>
			$(function(){

				var pin_index = 0;
				var master_pin_string = "";
				var master_pin_string2 = "";
				var master_pin_entry = "";

				$("#app_setup")
					.css({top: parseInt($(window).height() + 1, 10)});

				$("#app_setup2")
					.css({top: parseInt($(window).height() + 1, 10)});

				$("#app_login")
					.css({top: parseInt($(window).height() + 1, 10)});

				var logOut = function() {
					window.localStorage.removeItem("ct_masterpass");
                    window.localStorage.removeItem("ct_id_obj");
                    window.localStorage.removeItem("ct_msgs");
					location.reload();
				};

				var openPage = function(id, new_up_down, old_up_down) {
					var old = $(".page-open");
					var page = $(id);

					if (old) {
						switch (old_up_down) {
							case "up":
								old.animate({top: -parseInt($(window).height() + 1, 10)}, {complete: function(){
									$(this).addClass("hiding").removeClass("page-open");
								}});
							break;
							case "down":
								old.animate({top: parseInt($(window).height() + 1, 10)}, {complete: function(){
									$(this).addClass("hiding").removeClass("page-open");
								}});
							break;
						}
					}

					switch (new_up_down) {
						case "up":
							page
							.css({top: parseInt($(window).height() + 1, 10)})
							.removeClass("hiding")
							.animate({top: 0}, {complete: function(){
								$(this).addClass("page-open");
							}});
						break;
						case "down":
							page
							.css({top: -parseInt($(window).height() + 1, 10)})
							.removeClass("hiding")
							.animate({top: 0}, {complete: function(){
								$(this).addClass("page-open");
							}});
						break;
					}
				};

				var setup_app_password = window.localStorage.getItem("ct_masterpass");

				var get_master_pin = function() {
					return window.localStorage.getItem("ct_masterpass");
				};

				var active_id_object = function() {
					var enc_ident = window.localStorage.getItem("ct_id_obj");
					if (!enc_ident) {
						return false;
					}
					var identity = unciph(get_master_pin(), enc_ident);
					var id_parsed = JSON.parse(identity);
              
                    var privateKey = openpgp.key.readArmored(id_parsed.key.priv).keys[0];
                    privateKey.decrypt(get_master_pin());
                    id_parsed.unlocked_private_key = privateKey;

					return id_parsed;
				};
              
                window.active_id_object = active_id_object;

				var getLocalMessages = function() {
					return window.localStorage.getItem("ct_msgs");
				};

				var placeIdentityIntoStorage = function(id) {
					window.localStorage.setItem("ct_id_obj", id);
				};

				var generateNewIdentity = function() {
					$(".app-id-action").attr("disabled", "disabled").val("Creating New Identity...");
					$(".id-name").removeClass("hiding").css({color: "grey"}).html("Creating identity, please wait... ");

					var new_id_str = random_string(5)+"-"+random_string(5);

					var identity = {
						username: new_id_str,
						pgp_email: new_id_str+" <anon-"+new_id_str+"@getciphertext.com>"
					};

					window.openpgp.initWorker('openpgp.worker.js');
                    window.openpgp.generateKeyPair(1, 2048, identity.pgp_email, get_master_pin(), function(err, res){
                        if (err) {
                            $(".id-name").removeClass("hiding").css({color: "red"}).html("Error creating keypair: "+err);
                            return false;
                        }
                        
                        var new_key_pair = res;

                    	identity.key = {};
                    	identity.key.pub = new_key_pair.publicKeyArmored;
                    	identity.key.priv = new_key_pair.privateKeyArmored;
                        identity.key.raw = new_key_pair.key;

                        try {
                            ident_enc = ciph(get_master_pin(), JSON.stringify(identity));
                            placeIdentityIntoStorage(ident_enc);
                        } catch(_e) {
                            console.log(_e);
                        }

                        refreshIdStatus();
                        
                        return true;
                    });
				};

				var refreshIdStatus = function() {
					myId = active_id_object();

					if (!myId) {
						$(".app-id-action").removeAttr("disabled").attr("data-has-id", "0").val("Create First Identity");
						$(".id-name").removeClass("hiding").html("Create an identity to get started.");
					} else {
						$(".app-id-action").removeAttr("disabled").attr("data-has-id", "1").val("New Identity");
						$(".id-name").removeClass("hiding").html("Your ID: " + myId.username);
                        $(".id-display").html(myId.username);
						$(".app-messages").removeClass("hiding");
                        $(".app-identity-data").removeClass("hiding");
              
                        $(".id-created-date").html(myId.unlocked_private_key.primaryKey.created);
					}
				};

				refreshIdStatus();

				$(".app-id-action").on("click", function(){
					var has_id = $(this).attr("data-has-id") == "0" ? false : true;
					if (has_id) {
						var confirm_new = confirm("Are you sure? This will remove all data related to this identity and immediately create a new one.");
						if (confirm_new) {
							try {
								window.localStorage.removeItem("ct_id_obj");
								window.localStorage.removeItem("ct_msgs");
							} catch (e) { }
							generateNewIdentity();
						}
					} else {
						generateNewIdentity();
					}
				});

				if ( !setup_app_password ) {
					pin_index = 0;
					$("#app_setup")
						.css({display: "block"})
						.animate({top: 0});
				} else {
					pin_index = 0;
					$("#app_login")
						.css({display: "block"})
						.animate({top: 0});
				}

				$(".app-clear-pin").on("click", function(){
					logOut();
				});

				$(".app-exit").on("click", function(){
					location.reload();
				});

				$(".app-help").on("click", function(){
					openPage("#app_help", "up", "up");
				});

				$(".app-messages").on("click", function(){
					openPage("#app_messages", "up", "up");
				});

				$(".app-close-help").on("click", function(){
					openPage("#app_page", "down", "down");
				});

				$(".app-close-messages").on("click", function(){
					openPage("#app_page", "down", "down");
				});
              
                $(".app-close-id-data").on("click", function(){
                    openPage("#app_page", "down", "down");
                });
              
                $(".app-identity-data").on("click", function(){
                    refreshIdStatus();
                    openPage("#app_id_data", "up", "up");
                });

				$("#login_masterpass_form input[type=button]")
					.on("click", function(){
					var which_pin = pin_index;
					if ($(this).hasClass("pin-back")) {
						$("#login_masterpass_form input[data-idx="+(which_pin-1)+"]").val('');
						if (which_pin > 0) {
							pin_index = which_pin - 1;
						}
					} else {
						var btn_val = $(this).val();
						$("#login_masterpass_form input[data-idx="+which_pin+"]").val(btn_val);
						if (which_pin < 3) {
							pin_index = which_pin + 1;
						} else {
							$("#login_masterpass_form .pin-display").each(function(){
								master_pin_entry = "" + master_pin_entry+ "" + $(this).val();
							});

							if (master_pin_entry === setup_app_password) {
								$("#app_page").css({top: -parseInt($(window).height() + 1, 10)}).removeClass("hiding").animate({top: 0}).addClass("page-open");
								$("#app_login")
									.animate({top: parseInt($(window).height() + 1, 10)}, {complete: function(){
										$(this).hide();
									}});
							} else {
								alert("Incorrect PIN. Try again.");
								$(".pin-display").val("");
								pin_index = 0;
								master_pin_entry = "";
							}
						}
					}
				});

				$("#new_masterpass_form input[type=button]")
					.on("click", function(){
					var which_pin = pin_index;
					if ($(this).hasClass("pin-back")) {
						$("#new_masterpass_form input[data-idx="+(which_pin-1)+"]").val('');
						if (which_pin > 0) {
							pin_index = which_pin - 1;
						}
					} else {
						var btn_val = $(this).val();
						$("#new_masterpass_form input[data-idx="+which_pin+"]").val(btn_val);
						if (which_pin < 3) {
							pin_index = which_pin + 1;
						} else {
							pin_index = 0;
							$("#new_masterpass_form .pin-display").each(function(){
								master_pin_string = "" + master_pin_string + "" + $(this).val();
							});
							$("#app_setup")
								.hide()
								.css({top: parseInt($(window).height() + 1, 10)});
							$("#app_setup2")
								.css({display: "block"})
								.animate({top: 0});
						}
					}
				});

				$("#new_masterpass_form2 input[type=button]")
					.on("click", function(){
					var which_pin = pin_index;
					if ($(this).hasClass("pin-back")) {
						$("#new_masterpass_form2  input[data-idx="+(which_pin-1)+"]").val('');
						if (which_pin > 0) {
							pin_index = which_pin - 1;
						}
					} else {
						var btn_val = $(this).val();
						$("#new_masterpass_form2  input[data-idx="+which_pin+"]").val(btn_val);
						if (which_pin < 3) {
							pin_index = which_pin + 1;
						} else {
							// ----------------------  Save master PIN ---------------------- //
							$("#new_masterpass_form2 .pin-display").each(function(){
								master_pin_string2 = "" + master_pin_string2 + "" + $(this).val();
							});

							if (master_pin_string === master_pin_string2) {
								window.localStorage.setItem("ct_masterpass", master_pin_string2);
								$("#app_page").css({top: -parseInt($(window).height() + 1, 10)}).removeClass("hiding").animate({top: 0}).addClass("page-open");
								$("#app_setup2")
									.animate({top: parseInt($(window).height() + 1, 10)}, {complete: function(){
										$("#app_setup2").hide();
									}});
							} else {
								alert("PINs don't match. Try again.");
								$(".pin-display").val("");
								pin_index = 0;
								master_pin_string = "";
								master_pin_string2 = "";
								$("#app_setup2")
									.hide()
									.css({top: parseInt($(window).height() + 1, 10)});
								$("#app_setup")
									.css({display: "block"})
									.animate({top: 0});
							}
						}
					}
				});

/*
				$("#login_masterpass_form input[type=button]")
					.on("mousedown", function(){
					var which_pin = pin_index;
					if ($(this).hasClass("pin-back")) {
						$("#login_masterpass_form input[data-idx="+which_pin+"]").val('');
						if (which_pin > 0) {
							pin_index = which_pin - 1;
						}
					} else {
						var btn_val = $(this).val();
						$("#login_masterpass_form input[data-idx="+which_pin+"]").val(btn_val);
						if (which_pin < 3) {
							pin_index = which_pin + 1;
						}
					}
				});
*/

				$("#new_masterpass_form")
					.on("submit", function(){
					return false;
				});

				$("#login_masterpass_form")
					.on("submit", function(){
					return false;
				});
			});
		</script>
	</body>
</html>